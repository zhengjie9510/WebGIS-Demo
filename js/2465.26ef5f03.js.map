{"version":3,"file":"js/2465.26ef5f03.js","mappings":"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","sources":["webpack://webgis/./src/components/cesium/offscreen_rendering.vue","webpack://webgis/./src/components/cesium/plugins/MyPrimitive.js","webpack://webgis/./src/components/cesium/offscreen_rendering.vue?1aee"],"sourcesContent":["<template>\n  <div id=\"cesiumContainer\"></div>\n</template>\n\n<script>\nimport 'cesium/Build/Cesium/Widgets/widgets.css'\nimport * as Cesium from 'cesium'\nimport { default as MyPrimitive } from './plugins/MyPrimitive'\n\nexport default {\n  data() {\n    return { path: process.env.BASE_URL }\n  },\n  mounted() {\n    this.init()\n  },\n  methods: {\n    init() {\n      const viewer = new Cesium.Viewer('cesiumContainer')\n      if (Cesium.FeatureDetection.supportsImageRenderingPixelated()) {\n        //判断是否支持图像渲染像素化处理\n        viewer.resolutionScale = window.devicePixelRatio\n      }\n      viewer.scene.postProcessStages.fxaa.enabled = true\n      viewer.scene.debugShowFramesPerSecond = true;\n\n      const scene = viewer.scene;\n      const context = scene.context;\n      const framebuffer = new Cesium.Framebuffer({\n        context: context,\n        colorTextures: [\n          new Cesium.Texture({\n            context: context,\n            width: context.canvas.width * window.devicePixelRatio,\n            height: context.canvas.height * window.devicePixelRatio\n          })\n        ],\n        depthStencilRenderbuffer: new Cesium.Renderbuffer({\n          context: context,\n          width: context.canvas.width * window.devicePixelRatio,\n          height: context.canvas.height * window.devicePixelRatio,\n          format: Cesium.RenderbufferFormat.DEPTH_STENCIL\n        })\n      });\n      //模型矩阵\n      const modelMatrix = Cesium.Matrix4.multiplyByUniformScale(\n        Cesium.Matrix4.multiplyByTranslation(\n          Cesium.Transforms.eastNorthUpToFixedFrame(\n            Cesium.Cartesian3.fromDegrees(116.23, 39.54)\n          ),\n          new Cesium.Cartesian3(0.0, 0.0, 25),\n          new Cesium.Matrix4()\n        ),\n        200.0,\n        new Cesium.Matrix4()\n      )\n\n      const myPrimitive = new MyPrimitive(modelMatrix, context, framebuffer)\n      viewer.scene.primitives.add(myPrimitive)\n\n      const fragmentShaderSource = `\n        in vec2 v_textureCoordinates;\n        uniform sampler2D colorTexture;\n        uniform sampler2D renderTexture;\n        out vec4 fragColor;\n        void main(void) {\n            vec4 renderColor = texture(renderTexture, v_textureCoordinates);\n            vec4 color = texture(colorTexture, v_textureCoordinates);\n            if ((renderColor.r < 0.9 || renderColor.g < 0.9 || renderColor.b < 0.9) && renderColor.a > 0.2) {\n              fragColor = renderColor;\n            }\n            else {\n              fragColor = color;\n            }\n        }\n        `;\n\n      viewer.scene.postProcessStages.add(\n        new Cesium.PostProcessStage({\n          fragmentShader: fragmentShaderSource,\n          uniforms: {\n            renderTexture: myPrimitive.framebuffer._colorTextures[0]\n          },\n        })\n      );\n\n      const heading = Cesium.Math.toRadians(-90.0);\n      const pitch = Cesium.Math.toRadians(-90.0);\n      const range = 500.0;\n      viewer.camera.lookAt(Cesium.Cartesian3.fromDegrees(116.23, 39.54, 500), new Cesium.HeadingPitchRange(heading, pitch, range))\n      viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);\n\n      // 监听窗口的resize事件\n      window.addEventListener('resize', () => {\n        // 更新framebuffer的宽度和高度\n      });\n    },\n  },\n}\n</script>\n\n<style lang=\"scss\" scoped>\n#cesiumContainer {\n  position: absolute;\n  height: 100%;\n  width: 100%;\n}\n</style>\n","import * as Cesium from 'cesium'\nclass MyPrimitive {\n    constructor(modelMatrix, context, framebuffer = undefined) {\n        this.framebuffer = framebuffer;\n        this.context = context\n        this.width = context.canvas.width\n        var v0 = [0.5, 0.5, 0];\n        var v1 = [-0.5, 0.5, 0];\n        var v2 = [-0.5, -0.5, 0];\n        var v3 = [0.5, -0.5, 0];\n\n        var vertex = [\n            ...v0, ...v1, ...v2, ...v3\n        ]\n        var positions = new Float64Array(vertex)\n\n        var nny = [0, -1, 0]\n        var normals = new Float32Array([\n            ...nny, ...nny, ...nny, ...nny\n        ])\n\n        var sts = new Float32Array([\n            1., 1.,\n            0., 1.,\n            0., 0.,\n            1., 0.\n        ])\n\n        var indices = new Uint16Array([\n            0, 1, 2, 0, 2, 3\n        ])\n\n        //纹理\n        var texture = undefined\n        var imageUri = './favicon.ico'\n        Cesium.Resource.createIfNeeded(imageUri).fetchImage().then(function (image) {\n            var textureObj;\n            if (Cesium.defined(image.internalFormat)) {\n                textureObj = new Cesium.Texture({\n                    context: context,\n                    pixelFormat: image.internalFormat,\n                    width: image.width,\n                    height: image.height,\n                    source: {\n                        arrayBufferView: image.bufferView\n                    }\n                })\n            } else {\n                textureObj = new Cesium.Texture({\n                    context: context,\n                    source: image\n                })\n            }\n            texture = textureObj\n        })\n\n        // 1.6 定义attributeLocations\n        var attributeLocations = {\n            position: 0,\n            normal: 1,\n            textureCoordinates: 2,\n        };\n\n        var vs = `\n        in vec3 position;\n        in vec3 normal;\n        in vec2 st;\n        in float batchId;\n\n        out vec3 v_positionEC;\n        out vec3 v_normalEC;\n        out vec2 v_st;\n\n        void main(){\n            v_positionEC = (czm_modelView * vec4(position, 1.0)).xyz;\n            v_normalEC = czm_normal * normal;\n            v_st = st;\n            gl_Position = czm_modelViewProjection * vec4(position, 1.0);\n        }\n        `\n\n        var fs = `\n        in vec3 v_positionEC;\n        in vec3 v_normalEC;\n        in vec2 v_st;\n        uniform sampler2D myImage;\n        in vec3 v_normal;\n        out vec4 fragColor;\n        void main(){\n            vec3 positionToEyeEC = -v_positionEC;\n            vec3 normalEC = normalize(v_normalEC);\n            #ifdef FACE_FORWARD\n                normalEC = faceforward(normalEC, vec3(0.0, 0.0, 1.0), -normalEC);\n            #endif\n\n            czm_materialInput materialInput;\n            materialInput.normalEC = normalEC;\n            materialInput.positionToEyeEC = positionToEyeEC;\n            materialInput.st = v_st;\n\n            //An czm_material with default values. \n            //Every material's czm_getMaterial should use this default material as a base for the material it returns. \n            //The default normal value is given by materialInput.normalEC.\n            czm_material material = czm_getDefaultMaterial(materialInput);\n            material.diffuse = texture(myImage, materialInput.st).rgb;\n\n            // #ifdef FLAT\n                fragColor = vec4(material.diffuse + material.emission, material.alpha);  //vec4(normalEC.xyz,1.);\n            // #else\n            //     fragColor = czm_phong(normalize(positionToEyeEC), material);\n            // #endif\n        }\n        `\n        //创建vertexArray（Geometry）\n        function createVertexArray(context) {\n            var geometry = new Cesium.Geometry({\n                attributes: {\n                    position: new Cesium.GeometryAttribute({\n                        // vtxf 使用double类型的position进行计算\n                        // componentDatatype : Cesium.ComponentDatatype.DOUBLE,\n                        componentDatatype: Cesium.ComponentDatatype.FLOAT,\n                        componentsPerAttribute: 3,\n                        values: positions\n                    }),\n                    normal: new Cesium.GeometryAttribute({\n                        componentDatatype: Cesium.ComponentDatatype.FLOAT,\n                        componentsPerAttribute: 3,\n                        values: normals\n                    }),\n                    textureCoordinates: new Cesium.GeometryAttribute({\n                        componentDatatype: Cesium.ComponentDatatype.FLOAT,\n                        componentsPerAttribute: 2,\n                        values: sts\n                    })\n                },\n                // Workaround Internet Explorer 11.0.8 lack of TRIANGLE_FAN\n                indices: indices,\n                primitiveType: Cesium.PrimitiveType.TRIANGLES,\n                boundingSphere: Cesium.BoundingSphere.fromVertices(positions)\n            });\n\n            var vertexArray = Cesium.VertexArray.fromGeometry({\n                context: context,\n                geometry: geometry,\n                attributeLocations: attributeLocations,\n                bufferUsage: Cesium.BufferUsage.STATIC_DRAW,\n                // interleave : true\n            });\n\n            return vertexArray;\n        }\n\n        //创建command\n        function createCommand(context) {\n            var translucent = false\n            var closed = true\n            // 借用一下Appearance.getDefaultRenderState\n            var rawRenderState = Cesium.Appearance.getDefaultRenderState(translucent, closed, undefined);\n            var renderState = Cesium.RenderState.fromCache(rawRenderState);\n\n            var vertexShaderSource = new Cesium.ShaderSource({\n                sources: [vs]\n            });\n\n            var fragmentShaderSource = new Cesium.ShaderSource({\n                sources: [fs]\n            });\n\n            var uniformMap = {\n                myImage: function () {\n                    if (Cesium.defined(texture)) {\n                        return texture;\n                    } else {\n                        return context.defaultTexture;\n                    }\n                }\n            }\n\n            var shaderProgram = Cesium.ShaderProgram.fromCache({\n                context: context,\n                vertexShaderSource: vertexShaderSource,\n                fragmentShaderSource: fragmentShaderSource,\n                attributeLocations: attributeLocations\n            });\n\n            return new Cesium.DrawCommand({\n                vertexArray: createVertexArray(context),\n                primitiveType: Cesium.PrimitiveType.TRIANGLES,\n                renderState: renderState,\n                shaderProgram: shaderProgram,\n                uniformMap: uniformMap,\n                owner: this,\n                framebuffer: this.framebuffer ? this.framebuffer : undefined,\n                pass: Cesium.Pass.OPAQUE,\n                modelMatrix: modelMatrix,\n            })\n        }\n\n        //清空命令\n        function createClearCommand(fb) {\n            return new Cesium.ClearCommand({\n                pass: Cesium.Pass.OPAQUE,\n                color: new Cesium.Color(0., 0., 0., 0.),\n                framebuffer: this.framebuffer,\n                // stencil : 0,\n                // owner : this,\n                depth: 1.0,\n            })\n        }\n\n        this.show = true\n        this._command = undefined\n        this._createCommand = createCommand;\n\n        this._cCommand = undefined\n        this._createClearCommand = createClearCommand;\n    }\n\n    update(frameState) {\n        if (!this.show) {\n            return\n        }\n        if (!Cesium.defined(this._cCommand) && this.framebuffer) {\n            this._cCommand = this._createClearCommand()\n        }\n        if (Cesium.defined(this._cCommand)) {\n            frameState.commandList.push(this._cCommand)\n        }\n        if (!Cesium.defined(this._command)) {\n            this._command = this._createCommand(frameState.context)\n        }\n\n        this._command = this._createCommand(frameState.context)\n        if (Cesium.defined(this._command)) {\n            frameState.commandList.push(this._command)\n        }\n\n    }\n\n    isDestroyed() {\n        return false;\n    }\n\n    destroy() {\n        if (Cesium.defined(this._command)) {\n            this._command.shaderProgram = this._command.shaderProgram && this._command.shaderProgram.destroy();\n        }\n        return Cesium.destroyObject(this);\n    }\n}\nexport default MyPrimitive;","import { render } from \"./offscreen_rendering.vue?vue&type=template&id=088a5d59&scoped=true\"\nimport script from \"./offscreen_rendering.vue?vue&type=script&lang=js\"\nexport * from \"./offscreen_rendering.vue?vue&type=script&lang=js\"\n\nimport \"./offscreen_rendering.vue?vue&type=style&index=0&id=088a5d59&lang=scss&scoped=true\"\n\nimport exportComponent from \"/Users/zhengjie/Documents/webgis/node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-088a5d59\"]])\n\nexport default __exports__"],"names":["id","_createElementBlock","_hoisted_1","MyPrimitive","constructor","modelMatrix","context","framebuffer","this","width","canvas","v0","v1","v2","v3","vertex","positions","Float64Array","nny","normals","Float32Array","sts","indices","Uint16Array","texture","undefined","imageUri","Cesium","fetchImage","then","image","textureObj","internalFormat","pixelFormat","height","source","arrayBufferView","bufferView","attributeLocations","position","normal","textureCoordinates","vs","fs","createVertexArray","geometry","attributes","componentDatatype","componentsPerAttribute","values","primitiveType","boundingSphere","vertexArray","bufferUsage","createCommand","translucent","closed","rawRenderState","renderState","vertexShaderSource","sources","fragmentShaderSource","uniformMap","myImage","defaultTexture","shaderProgram","owner","pass","createClearCommand","fb","color","depth","show","_command","_createCommand","_cCommand","_createClearCommand","update","frameState","commandList","push","isDestroyed","destroy","data","path","process","mounted","init","methods","viewer","resolutionScale","window","devicePixelRatio","scene","postProcessStages","fxaa","enabled","debugShowFramesPerSecond","colorTextures","depthStencilRenderbuffer","format","myPrimitive","primitives","add","fragmentShader","uniforms","renderTexture","_colorTextures","heading","pitch","range","camera","lookAt","lookAtTransform","addEventListener","__exports__","render"],"sourceRoot":""}